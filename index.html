<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Farming Command Center</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-900 text-white min-h-screen font-sans selection:bg-green-500 selection:text-white">

    <!-- Navbar -->
    <nav class="bg-slate-900/90 sticky top-0 z-50 border-b border-slate-700 backdrop-blur-md">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-green-500 p-2 rounded-lg">
                    <i class="fas fa-leaf text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl font-bold tracking-tight">AgriSense <span class="text-green-400">Pro</span></h1>
                    <p class="text-xs text-slate-400">IoT Monitoring Station</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="downloadData()" class="hidden md:flex items-center gap-2 px-3 py-1 text-sm bg-slate-800 hover:bg-slate-700 rounded-md transition border border-slate-600">
                    <i class="fas fa-download"></i> Export
                </button>
                <div id="status-badge" class="flex items-center gap-2 px-3 py-1 rounded-full bg-red-500/20 text-red-400 border border-red-500/50 text-xs font-medium">
                    <span class="w-2 h-2 rounded-full bg-red-500 animate-pulse"></span>
                    DISCONNECTED
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-6 lg:p-8 space-y-6">
        
        <!-- Main Alerts Section -->
        <div id="alert-banner" class="hidden rounded-xl p-4 border-l-4 border-yellow-500 bg-yellow-500/10 flex items-start gap-4">
            <i class="fas fa-exclamation-triangle text-yellow-500 text-xl mt-1"></i>
            <div>
                <h3 class="font-bold text-yellow-400">Farming Alert</h3>
                <p id="advice" class="text-slate-300 text-sm">Analyzing conditions...</p>
            </div>
        </div>

        <!-- Top Metrics Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Temp -->
            <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                    <i class="fas fa-thermometer-half text-6xl text-orange-500"></i>
                </div>
                <h3 class="text-slate-400 text-sm font-medium mb-1">Temperature</h3>
                <div class="flex items-baseline gap-2">
                    <span id="temp" class="text-3xl font-bold text-white">--</span>
                    <span class="text-lg text-slate-500">°C</span>
                </div>
                <div class="mt-4 h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                    <div id="temp-bar" class="h-full bg-gradient-to-r from-orange-400 to-red-500 w-0 transition-all duration-1000"></div>
                </div>
            </div>

            <!-- Humidity -->
            <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
                <div class="absolute top-0 right-0 p-4 opacity-10 group-hover:opacity-20 transition">
                    <i class="fas fa-water text-6xl text-blue-500"></i>
                </div>
                <h3 class="text-slate-400 text-sm font-medium mb-1">Humidity</h3>
                <div class="flex items-baseline gap-2">
                    <span id="humidity" class="text-3xl font-bold text-white">--</span>
                    <span class="text-lg text-slate-500">%</span>
                </div>
                <div class="mt-4 h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                    <div id="hum-bar" class="h-full bg-gradient-to-r from-blue-400 to-cyan-500 w-0 transition-all duration-1000"></div>
                </div>
            </div>

            <!-- Rain Status -->
            <div id="rain-card" class="glass-panel rounded-xl p-5 relative overflow-hidden transition-colors duration-500">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i id="rain-bg-icon" class="fas fa-sun text-6xl text-white"></i>
                </div>
                <h3 class="text-slate-400 text-sm font-medium mb-1">Precipitation</h3>
                <div class="flex items-center gap-3 mt-1">
                    <i id="rain-icon" class="fas fa-sun text-2xl text-yellow-400"></i>
                    <span id="rain-status" class="text-2xl font-bold">Dry</span>
                </div>
                <p class="text-xs text-slate-500 mt-3">Sensor Value: <span id="rain-val">--</span></p>
            </div>

            <!-- Air Quality (Updated Logic) -->
            <div id="gas-card" class="glass-panel rounded-xl p-5 relative overflow-hidden transition-colors duration-500">
                <div class="absolute top-0 right-0 p-4 opacity-10">
                    <i id="gas-icon-bg" class="fas fa-wind text-6xl text-green-500"></i>
                </div>
                <h3 class="text-slate-400 text-sm font-medium mb-1">Air Quality</h3>
                <div class="flex items-baseline gap-2">
                    <span id="gas" class="text-3xl font-bold text-white">--</span>
                    <span class="text-xs text-slate-500">ADC Value</span>
                </div>
                <p id="gas-label" class="text-xs text-green-400 mt-2 font-bold">GOOD</p>
            </div>
        </div>

        <!-- Advanced Metrics Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Main Chart Area -->
            <div class="glass-panel rounded-xl p-6 lg:col-span-2">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-lg"><i class="fas fa-chart-line text-green-500 mr-2"></i>Live Trends</h3>
                    <div class="flex gap-2">
                        <span class="flex items-center text-xs text-slate-400"><span class="w-3 h-1 bg-orange-500 mr-1 rounded"></span> Temp</span>
                        <span class="flex items-center text-xs text-slate-400"><span class="w-3 h-1 bg-blue-500 mr-1 rounded"></span> Hum</span>
                    </div>
                </div>
                <div class="h-64">
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>

            <!-- Calculated Agronomy Metrics -->
            <div class="space-y-4">
                <!-- VPD Card -->
                <div class="glass-panel rounded-xl p-6 border-l-4 border-purple-500">
                    <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider">VPD (kPa)</h3>
                    <div class="flex justify-between items-end mt-2">
                        <span id="vpd-val" class="text-4xl font-bold text-white">--</span>
                        <span id="vpd-status" class="text-xs px-2 py-1 rounded bg-slate-800 text-purple-400">Calculating</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Vapor Pressure Deficit. Target: 0.8 - 1.2 kPa</p>
                </div>

                <!-- Dew Point Card -->
                <div class="glass-panel rounded-xl p-6 border-l-4 border-cyan-500">
                    <h3 class="text-slate-400 text-sm font-bold uppercase tracking-wider">Dew Point</h3>
                    <div class="flex justify-between items-end mt-2">
                        <span id="dew-val" class="text-4xl font-bold text-white">--</span>
                        <span class="text-lg text-slate-500">°C</span>
                    </div>
                    <p class="text-xs text-slate-500 mt-2">Condensation temperature.</p>
                </div>
                
                <!-- System Info -->
                <div class="glass-panel rounded-xl p-4">
                    <div class="flex justify-between text-xs text-slate-400 mb-2">
                        <span>Pressure:</span>
                        <span id="pressure" class="text-white">-- hPa</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400 mb-2">
                        <span>Light Level:</span>
                        <span id="light" class="text-white">--</span>
                    </div>
                    <div class="flex justify-between text-xs text-slate-400">
                        <span>Last Sync:</span>
                        <span id="timestamp" class="text-green-400 font-mono">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJVMT3dLB1QZLbvsD2009hH5Szy2HvlUA",
            authDomain: "weather-station-b45a7.firebaseapp.com",
            projectId: "weather-station-b45a7",
            storageBucket: "weather-station-b45a7.firebasestorage.app",
            messagingSenderId: "751863040022",
            appId: "1:751863040022:web:35365b3e6d37dc3e1d0d37",
            measurementId: "G-MYE28Q0DXP",
            databaseURL: "https://weather-station-b45a7-default-rtdb.firebaseio.com"
        };

        // Init Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Chart.js Setup
        const ctx = document.getElementById('weatherChart').getContext('2d');
        const weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temp (°C)',
                    data: [],
                    borderColor: '#f97316', // Orange
                    backgroundColor: 'rgba(249, 115, 22, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: '#3b82f6', // Blue
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: { display: false }, 
                    y: { 
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(255, 255, 255, 0.1)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Agronomy Calculations
        function calculateVPD(T, RH) {
            const SVP = 0.6108 * Math.exp((17.27 * T) / (T + 237.3));
            const AVP = SVP * (RH / 100);
            return (SVP - AVP).toFixed(2);
        }

        function calculateDewPoint(T, RH) {
            return (T - ((100 - RH) / 5)).toFixed(1);
        }

        let currentData = {};

        // Listen for Data
        db.ref('weather/current').on('value', (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            currentData = data;

            // 1. Status Badge
            const badge = document.getElementById('status-badge');
            badge.className = "flex items-center gap-2 px-3 py-1 rounded-full bg-green-500/20 text-green-400 border border-green-500/50 text-xs font-medium";
            badge.innerHTML = `<span class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></span> ONLINE`;

            // 2. Basic Values
            document.getElementById('temp').innerText = data.temperature ? data.temperature.toFixed(1) : "--";
            document.getElementById('humidity').innerText = data.humidity ? data.humidity.toFixed(0) : "--";
            document.getElementById('pressure').innerText = data.pressure ? data.pressure.toFixed(0) : "--";
            document.getElementById('gas').innerText = data.gas_level || "--";
            document.getElementById('light').innerText = data.light_intensity || "--";
            document.getElementById('timestamp').innerText = data.timestamp ? data.timestamp.split(' ')[1] : '--:--:--';
            document.getElementById('rain-val').innerText = data.rain_value;

            // 3. Progress Bars
            if(data.temperature) document.getElementById('temp-bar').style.width = Math.min((data.temperature / 50) * 100, 100) + "%";
            if(data.humidity) document.getElementById('hum-bar').style.width = data.humidity + "%";

            // 4. Rain Logic
            const isRaining = data.rain_value < 2500;
            const rainCard = document.getElementById('rain-card');
            if(isRaining) {
                rainCard.className = "glass-panel rounded-xl p-5 relative overflow-hidden bg-blue-900/50 border-blue-500 animate-pulse";
                document.getElementById('rain-status').innerText = "Raining";
                document.getElementById('rain-icon').className = "fas fa-cloud-showers-heavy text-2xl text-blue-300";
            } else {
                rainCard.className = "glass-panel rounded-xl p-5 relative overflow-hidden transition-colors duration-500";
                document.getElementById('rain-status').innerText = "Dry";
                document.getElementById('rain-icon').className = "fas fa-sun text-2xl text-yellow-400";
            }

            // 5. Air Quality Logic (FIXED)
            const gasVal = data.gas_level || 0;
            const gasLabel = document.getElementById('gas-label');
            const gasIconBg = document.getElementById('gas-icon-bg');
            const gasCard = document.getElementById('gas-card');

            // Standard MQ135 High = Dirty. 
            // 2200 is a common threshold for "noticeable smoke" on ESP32 ADC (0-4095)
            if(gasVal > 2200) {
                // POOR
                gasLabel.innerText = "POOR (SMOKE DETECTED)";
                gasLabel.className = "text-xs text-red-300 mt-2 font-bold animate-pulse";
                gasIconBg.className = "fas fa-smog text-6xl text-red-500";
                gasIconBg.parentElement.className = "absolute top-0 right-0 p-4 opacity-30"; // Make icon more visible
                gasCard.className = "glass-panel rounded-xl p-5 relative overflow-hidden border border-red-500 bg-red-900/20";
            } else if (gasVal > 1400) {
                // MODERATE
                gasLabel.innerText = "MODERATE";
                gasLabel.className = "text-xs text-yellow-400 mt-2 font-bold";
                gasIconBg.className = "fas fa-wind text-6xl text-yellow-500";
                gasCard.className = "glass-panel rounded-xl p-5 relative overflow-hidden border border-yellow-500/50";
            } else {
                // GOOD
                gasLabel.innerText = "GOOD";
                gasLabel.className = "text-xs text-green-400 mt-2 font-bold";
                gasIconBg.className = "fas fa-wind text-6xl text-green-500";
                gasCard.className = "glass-panel rounded-xl p-5 relative overflow-hidden";
            }

            // 6. Advice Banner
            const adviceEl = document.getElementById('advice');
            const banner = document.getElementById('alert-banner');
            adviceEl.innerText = data.farming_advice;
            
            if(data.farming_advice && !data.farming_advice.includes("OPTIMAL")) {
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }

            // 7. Advanced Calculations
            if(data.temperature && data.humidity) {
                const vpd = calculateVPD(data.temperature, data.humidity);
                const dew = calculateDewPoint(data.temperature, data.humidity);
                
                document.getElementById('vpd-val').innerText = vpd;
                document.getElementById('dew-val').innerText = dew;

                const vpdStatus = document.getElementById('vpd-status');
                if(vpd >= 0.8 && vpd <= 1.2) {
                    vpdStatus.innerText = "Optimal";
                    vpdStatus.className = "text-xs px-2 py-1 rounded bg-green-900 text-green-400";
                } else if (vpd > 1.6) {
                    vpdStatus.innerText = "Danger (Dry)";
                    vpdStatus.className = "text-xs px-2 py-1 rounded bg-red-900 text-red-400";
                } else {
                    vpdStatus.innerText = "Warning";
                    vpdStatus.className = "text-xs px-2 py-1 rounded bg-yellow-900 text-yellow-400";
                }
                
                // 8. Update Chart
                updateChart(data.temperature, data.humidity);
            }
        });

        // Chart Logic
        function updateChart(temp, hum) {
            const now = new Date();
            const timeLabel = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

            if(weatherChart.data.labels.length > 20) { 
                weatherChart.data.labels.shift();
                weatherChart.data.datasets[0].data.shift();
                weatherChart.data.datasets[1].data.shift();
            }
            
            weatherChart.data.labels.push(timeLabel);
            weatherChart.data.datasets[0].data.push(temp);
            weatherChart.data.datasets[1].data.push(hum);
            weatherChart.update();
        }

        // Export Function
        function downloadData() {
            if(!currentData.temperature) { alert("No data yet!"); return; }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Metric,Value\n"
                + `Temperature,${currentData.temperature}\n`
                + `Humidity,${currentData.humidity}\n`
                + `Pressure,${currentData.pressure}\n`
                + `Rain Value,${currentData.rain_value}\n`
                + `Gas Level,${currentData.gas_level}\n`
                + `Timestamp,${currentData.timestamp}`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "farming_data.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
