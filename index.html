<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Smart Farm Dashboard üöú</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@300;400;500;600&display=swap');

        body {
            font-family: 'Fredoka', sans-serif; /* Friendly rounded font */
            background: linear-gradient(180deg, #e0f2fe 0%, #dcfce7 100%); /* Sky to Grass */
        }

        .fun-card {
            background: rgba(255, 255, 255, 0.9);
            border-radius: 1.5rem; /* Super rounded */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            border: 3px solid white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .fun-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #86efac; /* Green border on hover */
        }

        .tooltip {
            visibility: hidden;
            position: absolute;
            bottom: 110%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #0f172a;
            color: #fff;
            padding: 0.75rem;
            border-radius: 1rem;
            font-size: 0.85rem;
            width: 200px;
            text-align: center;
            white-space: normal;
            z-index: 20;
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        
        .tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #0f172a transparent transparent transparent;
        }

        .has-tooltip:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        .animate-bounce-slow {
            animation: bounce 3s infinite;
        }
    </style>
</head>
<body class="text-slate-800 min-h-screen">

    <!-- Navbar -->
    <nav class="bg-white/80 sticky top-0 z-50 border-b border-green-200 backdrop-blur-md shadow-sm">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="bg-green-500 p-2 rounded-2xl shadow-lg shadow-green-500/20 animate-bounce-slow">
                    <i class="fas fa-tractor text-white text-2xl"></i>
                </div>
                <div>
                    <h1 class="text-2xl font-bold tracking-tight text-green-700">Smart Weather & Farm <span class="text-orange-500">Dashboard</span></h1>
                    <p class="text-xs font-bold text-slate-500">Udaya Public School</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <a href="#how-it-works" class="hidden md:flex items-center gap-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-full font-bold hover:bg-blue-200 transition">
                    <i class="fas fa-question-circle"></i> How it works?
                </a>
                <button onclick="downloadData()" class="hidden md:flex items-center gap-2 px-4 py-2 bg-slate-100 text-slate-700 rounded-full font-bold hover:bg-slate-200 transition">
                    <i class="fas fa-file-export"></i> Save Data
                </button>
                <div id="status-badge" class="flex items-center gap-2 px-4 py-2 rounded-full bg-red-100 text-red-600 border-2 border-red-200 text-sm font-bold shadow-sm">
                    <span class="w-3 h-3 rounded-full bg-red-500 animate-pulse"></span>
                    OFFLINE
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto p-4 md:p-6 lg:p-8 space-y-8">
        
        <!-- Welcome Banner -->
        <div class="bg-white rounded-3xl p-6 shadow-md border-l-8 border-green-500 flex flex-col md:flex-row items-center justify-between gap-4">
            <div>
                <h2 class="text-3xl font-bold text-slate-800">Welcome to Our Smart Farm Station! üå±</h2>
                <p class="text-slate-600 mt-1">Here is the live data from your IoT sensors. Let's check if the plants are happy!</p>
            </div>
            <div id="alert-box" class="hidden bg-yellow-100 px-6 py-3 rounded-2xl border-2 border-yellow-300 flex items-center gap-3">
                <i class="fas fa-bell text-yellow-600 text-2xl animate-swing"></i>
                <div>
                    <h3 class="font-bold text-yellow-800 uppercase text-xs">Farm Advice</h3>
                    <p id="advice" class="font-bold text-yellow-700">Checking...</p>
                </div>
            </div>
        </div>

        <!-- Sensor Cards Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
            
            <!-- Temperature Card -->
            <div class="fun-card p-6 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 bg-orange-100 w-24 h-24 rounded-full flex items-center justify-center opacity-50 group-hover:scale-110 transition">
                    <i class="fas fa-sun text-4xl text-orange-400 mt-4 mr-4"></i>
                </div>
                <div class="has-tooltip cursor-help w-fit">
                    <h3 class="text-slate-500 font-bold uppercase tracking-wider text-sm flex items-center gap-2">
                        <i class="fas fa-thermometer-half text-orange-500"></i> Temperature
                    </h3>
                    <span class="tooltip">This tells us how hot or cold the air is. Plants grow best between 20¬∞C and 30¬∞C! üå°Ô∏è</span>
                </div>
                
                <div class="mt-4">
                    <div class="flex items-baseline gap-2">
                        <span id="temp" class="text-5xl font-bold text-slate-800">--</span>
                        <span class="text-xl font-bold text-slate-400">¬∞C</span>
                    </div>
                    <p class="text-sm text-slate-500 font-medium mt-1">Is it hot outside?</p>
                </div>
                <div class="mt-4 h-3 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                    <div id="temp-bar" class="h-full bg-gradient-to-r from-yellow-300 to-red-500 w-0 transition-all duration-1000 rounded-full"></div>
                </div>
            </div>

            <!-- Humidity Card -->
            <div class="fun-card p-6 relative overflow-hidden group">
                <div class="absolute -right-6 -top-6 bg-blue-100 w-24 h-24 rounded-full flex items-center justify-center opacity-50 group-hover:scale-110 transition">
                    <i class="fas fa-tint text-4xl text-blue-400 mt-4 mr-4"></i>
                </div>
                <div class="has-tooltip cursor-help w-fit">
                    <h3 class="text-slate-500 font-bold uppercase tracking-wider text-sm flex items-center gap-2">
                        <i class="fas fa-water text-blue-500"></i> Humidity
                    </h3>
                    <span class="tooltip">This measures water vapor in the air. üíß High humidity means sticky air!</span>
                </div>

                <div class="mt-4">
                    <div class="flex items-baseline gap-2">
                        <span id="humidity" class="text-5xl font-bold text-slate-800">--</span>
                        <span class="text-xl font-bold text-slate-400">%</span>
                    </div>
                    <p class="text-sm text-slate-500 font-medium mt-1">How wet is the air?</p>
                </div>
                <div class="mt-4 h-3 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-200">
                    <div id="hum-bar" class="h-full bg-gradient-to-r from-cyan-300 to-blue-500 w-0 transition-all duration-1000 rounded-full"></div>
                </div>
            </div>

            <!-- Rain Status -->
            <div id="rain-card" class="fun-card p-6 relative overflow-hidden transition-colors duration-500">
                <div class="absolute -right-6 -top-6 bg-yellow-100 w-24 h-24 rounded-full flex items-center justify-center opacity-50">
                    <i id="rain-bg-icon" class="fas fa-umbrella text-4xl text-yellow-500 mt-4 mr-4"></i>
                </div>
                <div class="has-tooltip cursor-help w-fit">
                    <h3 class="text-slate-500 font-bold uppercase tracking-wider text-sm flex items-center gap-2">
                        <i class="fas fa-cloud-rain text-indigo-500"></i> Rain Sensor
                    </h3>
                    <span class="tooltip">A special plate that conducts electricity when water touches it! ‚òî</span>
                </div>

                <div class="mt-4">
                    <div class="flex items-center gap-3">
                        <i id="rain-icon" class="fas fa-sun text-4xl text-yellow-400 animate-spin-slow"></i>
                        <span id="rain-status" class="text-3xl font-bold text-slate-800">Dry</span>
                    </div>
                    <p class="text-sm text-slate-500 font-medium mt-2">Current Condition</p>
                </div>
                <div class="mt-4 px-3 py-1 bg-slate-100 rounded-lg text-xs font-mono text-slate-400 inline-block border border-slate-200">
                    Sensor Value: <span id="rain-val">--</span>
                </div>
            </div>

            <!-- Air Quality -->
            <div id="gas-card" class="fun-card p-6 relative overflow-hidden transition-colors duration-500">
                <div class="absolute -right-6 -top-6 bg-green-100 w-24 h-24 rounded-full flex items-center justify-center opacity-50">
                    <i id="gas-icon-bg" class="fas fa-wind text-4xl text-green-500 mt-4 mr-4"></i>
                </div>
                <div class="has-tooltip cursor-help w-fit">
                    <h3 class="text-slate-500 font-bold uppercase tracking-wider text-sm flex items-center gap-2">
                        <i class="fas fa-lungs text-pink-500"></i> Air Quality
                    </h3>
                    <span class="tooltip">Detects smoke and gases. Essential for keeping plants (and us) healthy! üçÉ</span>
                </div>

                <div class="mt-4">
                    <div class="flex items-baseline gap-2">
                        <span id="gas" class="text-5xl font-bold text-slate-800">--</span>
                        <span class="text-xs text-slate-400 font-bold">PPM</span>
                    </div>
                    <div id="gas-badge" class="mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold border border-green-200">
                        <i class="fas fa-check-circle"></i> <span>Fresh Air</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts and Science Row -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            
            <!-- Main Chart Area -->
            <div class="fun-card p-6 lg:col-span-2 border-l-8 border-blue-400">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="font-bold text-xl text-slate-800 flex items-center gap-2">
                        <i class="fas fa-chart-line text-blue-500"></i> Live Data Graph
                    </h3>
                    <div class="flex gap-4">
                        <span class="flex items-center text-xs font-bold text-slate-600"><span class="w-3 h-3 bg-orange-400 mr-2 rounded-full"></span> Temp (¬∞C)</span>
                        <span class="flex items-center text-xs font-bold text-slate-600"><span class="w-3 h-3 bg-blue-400 mr-2 rounded-full"></span> Humidity (%)</span>
                    </div>
                </div>
                <div class="h-64 bg-slate-50 rounded-2xl p-2 border border-slate-100">
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>

            <!-- Plant Science Stats -->
            <div class="space-y-6">
                <!-- VPD Card -->
                <div class="fun-card p-6 border-l-8 border-purple-400 bg-purple-50">
                    <div class="has-tooltip cursor-help w-fit">
                         <h3 class="text-purple-900 text-sm font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                             <i class="fas fa-leaf"></i> Plant Thirst (VPD)
                         </h3>
                         <span class="tooltip">Vapor Pressure Deficit. It tells us if the air is sucking water out of the leaves too fast!</span>
                    </div>
                    <div class="flex justify-between items-end">
                        <span id="vpd-val" class="text-4xl font-bold text-slate-800">--</span>
                        <span id="vpd-status" class="text-xs px-2 py-1 rounded-lg bg-white text-purple-600 font-bold shadow-sm border border-purple-100">Calculating</span>
                    </div>
                    <p class="text-xs text-purple-700 mt-2 font-medium">Goal: Keep between 0.8 and 1.2 for happy plants!</p>
                </div>

                <!-- Dew Point Card -->
                <div class="fun-card p-6 border-l-8 border-cyan-400 bg-cyan-50">
                    <div class="has-tooltip cursor-help w-fit">
                        <h3 class="text-cyan-900 text-sm font-bold uppercase tracking-wider mb-1 flex items-center gap-2">
                            <i class="fas fa-tint"></i> Dew Point
                        </h3>
                        <span class="tooltip">If the temperature drops to this number, dew drops will form on the grass! üåø</span>
                   </div>
                    <div class="flex justify-between items-end">
                        <span id="dew-val" class="text-4xl font-bold text-slate-800">--</span>
                        <span class="text-xl font-bold text-slate-400">¬∞C</span>
                    </div>
                </div>
                
                <!-- System Info -->
                <div class="fun-card p-4 bg-slate-50 border-slate-200">
                    <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                        <span><i class="fas fa-compress-arrows-alt mr-1"></i> Pressure:</span>
                        <span id="pressure" class="text-slate-800">-- hPa</span>
                    </div>
                    <div class="flex justify-between text-xs font-bold text-slate-500 mb-2">
                        <span><i class="fas fa-lightbulb mr-1"></i> Light:</span>
                        <span id="light" class="text-slate-800">--</span>
                    </div>
                    <div class="flex justify-between text-xs font-bold text-slate-500">
                        <span><i class="fas fa-clock mr-1"></i> Last Update:</span>
                        <span id="timestamp" class="text-green-600 font-mono bg-green-100 px-2 rounded">--:--:--</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- HOW IT WORKS SECTION -->
        <div id="how-it-works" class="mt-16 pt-10 border-t-4 border-dashed border-green-200">
            <h2 class="text-3xl font-bold text-center text-slate-800 mb-2">How Does It Work? üß©</h2>
            <p class="text-center text-slate-500 mb-10 max-w-2xl mx-auto font-medium">Follow the path of the data from the farm to your screen!</p>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                
                <!-- Step 1 -->
                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-8 border-orange-400 relative">
                    <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 w-12 h-12 bg-orange-400 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-md">1</div>
                    <div class="mt-4 text-center">
                        <i class="fas fa-microchip text-5xl text-orange-200 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">The Sensors Feel</h3>
                        <p class="text-sm text-slate-500 leading-relaxed">
                            Just like we have 5 senses, our project has sensors!
                            <br><br>
                            <b>DHT11 & BMP280</b> feel heat.<br>
                            <b>Rain Sensor</b> feels water.<br>
                            <b>MQ-135</b> smells the air.
                        </p>
                    </div>
                </div>

                <!-- Step 2 -->
                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-8 border-blue-400 relative">
                    <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 w-12 h-12 bg-blue-400 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-md">2</div>
                    <div class="mt-4 text-center">
                        <i class="fas fa-brain text-5xl text-blue-200 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">The ESP32 Thinks</h3>
                        <p class="text-sm text-slate-500 leading-relaxed">
                            The <b>ESP32</b> is a tiny computer brain. It collects all the feelings from the sensors and translates them into numbers.
                            <br><br>
                            Then, it uses <b>Wi-Fi</b> to shout these numbers to the internet! üì°
                        </p>
                    </div>
                </div>

                <!-- Step 3 -->
                <div class="bg-white p-6 rounded-3xl shadow-lg border-b-8 border-green-400 relative">
                    <div class="absolute -top-6 left-1/2 transform -translate-x-1/2 w-12 h-12 bg-green-400 rounded-full flex items-center justify-center text-white font-bold text-xl shadow-md">3</div>
                    <div class="mt-4 text-center">
                        <i class="fas fa-cloud text-5xl text-green-200 mb-4"></i>
                        <h3 class="text-xl font-bold text-slate-800 mb-2">The Cloud Shows</h3>
                        <p class="text-sm text-slate-500 leading-relaxed">
                            The numbers land in <b>Google Firebase</b> (a cloud database). 
                            <br><br>
                            This website watches the database. The moment a number changes, the graphs and cards update instantly like magic! ‚ú®
                        </p>
                    </div>
                </div>

            </div>
            
            <div class="mt-12 text-center pb-8">
                 <p class="text-sm font-bold text-slate-400">Powered by ESP32, IoT & Google Firebase üöÄ</p>
            </div>
        </div>

    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyBJVMT3dLB1QZLbvsD2009hH5Szy2HvlUA",
            authDomain: "weather-station-b45a7.firebaseapp.com",
            projectId: "weather-station-b45a7",
            storageBucket: "weather-station-b45a7.firebasestorage.app",
            messagingSenderId: "751863040022",
            appId: "1:751863040022:web:35365b3e6d37dc3e1d0d37",
            measurementId: "G-MYE28Q0DXP",
            databaseURL: "https://weather-station-b45a7-default-rtdb.firebaseio.com"
        };

        // Init Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // Chart.js Setup - Kid Friendly Colors
        const ctx = document.getElementById('weatherChart').getContext('2d');
        const weatherChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Temp (¬∞C)',
                    data: [],
                    borderColor: '#fb923c', // Orange-400
                    backgroundColor: 'rgba(251, 146, 60, 0.2)',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#fb923c',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y'
                },
                {
                    label: 'Humidity (%)',
                    data: [],
                    borderColor: '#60a5fa', // Blue-400
                    backgroundColor: 'rgba(96, 165, 250, 0.2)',
                    borderWidth: 3,
                    pointRadius: 4,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#60a5fa',
                    tension: 0.4,
                    fill: true,
                    yAxisID: 'y1'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: { display: false }, 
                    y: { 
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: { color: 'rgba(0, 0, 0, 0.05)' }
                    },
                    y1: {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: { drawOnChartArea: false }
                    }
                },
                plugins: {
                    legend: { display: false }
                }
            }
        });

        // Agronomy Calculations
        function calculateVPD(T, RH) {
            const SVP = 0.6108 * Math.exp((17.27 * T) / (T + 237.3));
            const AVP = SVP * (RH / 100);
            return (SVP - AVP).toFixed(2);
        }

        function calculateDewPoint(T, RH) {
            return (T - ((100 - RH) / 5)).toFixed(1);
        }

        let currentData = {};

        // Listen for Data
        db.ref('weather/current').on('value', (snapshot) => {
            const data = snapshot.val();
            if(!data) return;

            currentData = data;

            // 1. Status Badge
            const badge = document.getElementById('status-badge');
            badge.className = "flex items-center gap-2 px-4 py-2 rounded-full bg-green-100 text-green-700 border-2 border-green-200 text-sm font-bold shadow-sm";
            badge.innerHTML = `<span class="w-3 h-3 rounded-full bg-green-500 animate-pulse"></span> ONLINE`;

            // 2. Basic Values
            document.getElementById('temp').innerText = data.temperature ? data.temperature.toFixed(1) : "--";
            document.getElementById('humidity').innerText = data.humidity ? data.humidity.toFixed(0) : "--";
            document.getElementById('pressure').innerText = data.pressure ? data.pressure.toFixed(0) : "--";
            document.getElementById('gas').innerText = data.gas_level || "--";
            document.getElementById('light').innerText = data.light_intensity || "--";
            document.getElementById('timestamp').innerText = data.timestamp ? data.timestamp.split(' ')[1] : '--:--:--';
            document.getElementById('rain-val').innerText = data.rain_value;

            // 3. Progress Bars
            if(data.temperature) document.getElementById('temp-bar').style.width = Math.min((data.temperature / 50) * 100, 100) + "%";
            if(data.humidity) document.getElementById('hum-bar').style.width = data.humidity + "%";

            // 4. Rain Logic - Fun visuals
            const isRaining = data.rain_value < 2500;
            const rainCard = document.getElementById('rain-card');
            const rainIcon = document.getElementById('rain-icon');
            const rainStatus = document.getElementById('rain-status');

            if(isRaining) {
                rainCard.className = "fun-card p-6 relative overflow-hidden bg-blue-50 border-blue-200";
                rainStatus.innerText = "It's Raining! ‚òî";
                rainStatus.className = "text-2xl font-bold text-blue-700";
                rainIcon.className = "fas fa-cloud-showers-heavy text-4xl text-blue-500 animate-bounce";
            } else {
                rainCard.className = "fun-card p-6 relative overflow-hidden transition-colors duration-500";
                rainStatus.innerText = "Dry / Sunny ‚òÄÔ∏è";
                rainStatus.className = "text-2xl font-bold text-slate-800";
                rainIcon.className = "fas fa-sun text-4xl text-yellow-400 animate-spin-slow";
            }

            // 5. Air Quality Logic - Fun Badges
            const gasVal = data.gas_level || 0;
            const gasBadge = document.getElementById('gas-badge');
            const gasCard = document.getElementById('gas-card');

            if(gasVal > 2200) {
                gasBadge.innerHTML = `<i class="fas fa-exclamation-circle"></i> <span>Yuck! Smoke! üò∑</span>`;
                gasBadge.className = "mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-red-100 text-red-700 text-xs font-bold border border-red-200 animate-pulse";
                gasCard.className = "fun-card p-6 relative overflow-hidden border-red-300 bg-red-50";
            } else if (gasVal > 1400) {
                gasBadge.innerHTML = `<i class="fas fa-meh"></i> <span>Not Great üòê</span>`;
                gasBadge.className = "mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-yellow-100 text-yellow-700 text-xs font-bold border border-yellow-200";
                gasCard.className = "fun-card p-6 relative overflow-hidden border-yellow-300 bg-yellow-50";
            } else {
                gasBadge.innerHTML = `<i class="fas fa-check-circle"></i> <span>Fresh Air üçÉ</span>`;
                gasBadge.className = "mt-2 inline-flex items-center gap-1 px-3 py-1 rounded-full bg-green-100 text-green-700 text-xs font-bold border border-green-200";
                gasCard.className = "fun-card p-6 relative overflow-hidden";
            }

            // 6. Advice Banner
            const adviceEl = document.getElementById('advice');
            const banner = document.getElementById('alert-box');
            adviceEl.innerText = data.farming_advice;
            
            if(data.farming_advice && !data.farming_advice.includes("OPTIMAL")) {
                banner.classList.remove('hidden');
            } else {
                banner.classList.add('hidden');
            }

            // 7. Advanced Calculations
            if(data.temperature && data.humidity) {
                const vpd = calculateVPD(data.temperature, data.humidity);
                const dew = calculateDewPoint(data.temperature, data.humidity);
                
                document.getElementById('vpd-val').innerText = vpd;
                document.getElementById('dew-val').innerText = dew;

                const vpdStatus = document.getElementById('vpd-status');
                if(vpd >= 0.8 && vpd <= 1.2) {
                    vpdStatus.innerText = "Happy Plants!";
                    vpdStatus.className = "text-xs px-2 py-1 rounded-lg bg-green-100 text-green-700 font-bold border border-green-200";
                } else if (vpd > 1.6) {
                    vpdStatus.innerText = "Thirsty Air!";
                    vpdStatus.className = "text-xs px-2 py-1 rounded-lg bg-red-100 text-red-700 font-bold border border-red-200";
                } else {
                    vpdStatus.innerText = "Be Careful";
                    vpdStatus.className = "text-xs px-2 py-1 rounded-lg bg-yellow-100 text-yellow-700 font-bold border border-yellow-200";
                }
                
                // 8. Update Chart
                updateChart(data.temperature, data.humidity);
            }
        });

        // Chart Logic
        function updateChart(temp, hum) {
            const now = new Date();
            const timeLabel = now.getHours() + ":" + now.getMinutes() + ":" + now.getSeconds();

            if(weatherChart.data.labels.length > 20) { 
                weatherChart.data.labels.shift();
                weatherChart.data.datasets[0].data.shift();
                weatherChart.data.datasets[1].data.shift();
            }
            
            weatherChart.data.labels.push(timeLabel);
            weatherChart.data.datasets[0].data.push(temp);
            weatherChart.data.datasets[1].data.push(hum);
            weatherChart.update();
        }

        // Export Function
        function downloadData() {
            if(!currentData.temperature) { alert("Wait for data to appear first!"); return; }
            
            const csvContent = "data:text/csv;charset=utf-8," 
                + "Metric,Value\n"
                + `Temperature,${currentData.temperature}\n`
                + `Humidity,${currentData.humidity}\n`
                + `Pressure,${currentData.pressure}\n`
                + `Rain Value,${currentData.rain_value}\n`
                + `Gas Level,${currentData.gas_level}\n`
                + `Timestamp,${currentData.timestamp}`;

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "my_farming_project.csv");
            document.body.appendChild(link);
            link.click();
        }
    </script>
</body>
</html>
